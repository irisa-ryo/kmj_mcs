<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åœ¨åº«CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Hiragino Sans', sans-serif; background: #f0f4f8; }
  .header { background: #2c3e50; color: white; padding: 12px 20px; }
  .content { padding: 20px; max-width: 700px; margin: 0 auto; }
  .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  input[type=file] { margin: 10px 0; }
  button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; margin-right: 10px; }
  .btn-primary { background: #3498db; color: white; }
  .btn-success { background: #27ae60; color: white; }
  pre { margin-top: 20px; padding: 12px; background: #f4f4f4; border-radius: 6px; min-height: 60px; white-space: pre-wrap; word-break: break-all; font-size: 13px; }
  .locked { text-align: center; padding: 60px 20px; color: #e74c3c; font-size: 18px; }
  .hidden { display: none; }
</style>
</head>
<body>

<div class="header">
  <span>ğŸ“¦ åœ¨åº«CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
</div>

<div class="content">
  <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã®å ´åˆã¯ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º -->
  <div id="lockedMessage" class="card locked hidden">
    ğŸ”’ ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
  </div>

  <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚ã‚Šã®å ´åˆã¯ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º -->
  <div id="mainContent" class="hidden">
    <div class="card">
      <h2 style="margin-bottom:12px;">åœ¨åº«CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
      <p style="margin-bottom:12px; color:#666; font-size:14px;">
        CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆ1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€è¡Œï¼‰ï¼š<br>
        <code>å€‰åº«ã‚³ãƒ¼ãƒ‰,å“ç•ª,å“å,æ•°é‡,å•†å“å˜ä¾¡</code>
      </p>
      <input type="file" id="csvFile" accept=".csv"><br>
      <button class="btn-success" id="btnUpload">â¬†ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      <button class="btn-primary" id="btnTest">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
    </div>

    <pre id="log">ã“ã“ã«ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</pre>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

  // ==================== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š ====================
  // â˜…pos_system.htmlã®PC_PASSWORDã¨åŒã˜å€¤ã«ã—ã¦ãã ã•ã„
  var UPLOAD_PASSWORD = 'kmj11111';

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: upload_csv.html?pw=kmj11111ï¼‰
  var urlParams = new URLSearchParams(window.location.search);
  var isAllowed = urlParams.get('pw') === UPLOAD_PASSWORD;

  if (!isAllowed) {
    document.getElementById('lockedMessage').classList.remove('hidden');
    return; // ä»¥é™ã®å‡¦ç†ã‚’ã™ã¹ã¦åœæ­¢
  }

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰OKã®å ´åˆã¯ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã€ãƒ­ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
  document.getElementById('lockedMessage').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');

  // ==================== Supabaseè¨­å®š ====================
  const SUPABASE_URL = 'https://exvbrwcpaoxxatokqfta.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4dmJyd2NwYW94eGF0b2txZnRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MTgyNDQsImV4cCI6MjA4Njk5NDI0NH0.HmrY7SWbWvJhzao1L4270YHK0ypE4HQXvCh3Z50uH18';

  const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  var log = document.getElementById('log');

  document.getElementById('btnTest').addEventListener('click', testConnection);
  document.getElementById('btnUpload').addEventListener('click', uploadCSV);

  function addLog(msg) {
    if (log.textContent === 'ã“ã“ã«ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™') log.textContent = '';
    log.textContent += msg + '\n';
    console.log(msg);
  }

  async function testConnection() {
    log.textContent = '';
    addLog('æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
    try {
      var result = await db.from('inventory').select('count');
      if (result.error) throw result.error;
      addLog('âœ… Supabaseæ¥ç¶šæˆåŠŸï¼');
    } catch(e) {
      addLog('âŒ æ¥ç¶šå¤±æ•—: ' + e.message);
    }
  }

  async function uploadCSV() {
    log.textContent = '';
    var file = document.getElementById('csvFile').files[0];
    if (!file) { addLog('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

    addLog('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­: ' + file.name);

    var text;
    try {
      text = await file.text();
    } catch(e) {
      addLog('âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message);
      return;
    }

    text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    var lines = text.trim().split('\n');

    if (lines.length < 2) { addLog('âŒ CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ˜ãƒƒãƒ€è¡Œã®ã¿ï¼‰'); return; }

    addLog('ãƒ˜ãƒƒãƒ€: ' + lines[0]);
    addLog('ãƒ‡ãƒ¼ã‚¿è¡Œæ•°: ' + (lines.length - 1) + 'è¡Œ');

    var rows = [];
    var errors = [];
    for (var i = 1; i < lines.length; i++) {
      var line = lines[i].trim();
      if (!line) continue;

      var cols = parseCSVLine(line);
      if (cols.length < 5) { errors.push('è¡Œ' + (i+1) + ': ã‚«ãƒ©ãƒ æ•°ä¸è¶³ â†’ ' + line); continue; }

      var warehouse_code = cols[0].trim().replace(/^"|"$/g, '');
      var item_code      = cols[1].trim().replace(/^"|"$/g, '');
      var item_name      = cols[2].trim().replace(/^"|"$/g, '');
      var quantity       = cols[3].trim().replace(/^"|"$/g, '');
      var unit_price     = cols[4].trim().replace(/^"|"$/g, '');
      var qty   = parseInt(quantity);
      var price = parseInt(unit_price);

      if (isNaN(qty) || isNaN(price)) {
        errors.push('è¡Œ' + (i+1) + ': æ•°å€¤å¤‰æ›ã‚¨ãƒ©ãƒ¼ï¼ˆæ•°é‡="' + quantity + '", å˜ä¾¡="' + unit_price + '"ï¼‰');
        continue;
      }
      rows.push({ warehouse_code: warehouse_code, item_code: item_code, item_name: item_name, quantity: qty, unit_price: price });
    }

    if (errors.length > 0) {
      addLog('\nâš ï¸ ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã®è¡Œ:');
      errors.forEach(function(e) { addLog('  ' + e); });
    }

    if (rows.length === 0) { addLog('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

    // é‡è¤‡é™¤å»
    var uniqueMap = {};
    rows.forEach(function(r) { uniqueMap[r.warehouse_code + '___' + r.item_code] = r; });
    var uniqueRows = Object.values(uniqueMap);
    if (uniqueRows.length < rows.length) {
      addLog('âš ï¸ é‡è¤‡è¡Œã‚’é™¤å»: ' + (rows.length - uniqueRows.length) + 'ä»¶ â†’ ' + uniqueRows.length + 'ä»¶ã«æ•´ç†');
    }

    addLog('\nã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ' + uniqueRows.length + 'ä»¶');
    addLog('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå…ˆé ­3ä»¶ï¼‰:');
    uniqueRows.slice(0, 3).forEach(function(r, i) { addLog('  ' + (i+1) + ': ' + JSON.stringify(r)); });

    var chunkSize = 50;
    var successCount = 0;
    for (var j = 0; j < uniqueRows.length; j += chunkSize) {
      var chunk = uniqueRows.slice(j, j + chunkSize);
      var result = await db.from('inventory').upsert(chunk, { onConflict: 'warehouse_code,item_code' });
      if (result.error) {
        addLog('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + result.error.message);
        addLog('è©³ç´°: ' + JSON.stringify(result.error));
        return;
      }
      successCount += chunk.length;
      addLog('é€²æ—: ' + successCount + '/' + uniqueRows.length + 'ä»¶å®Œäº†');
    }

    addLog('\nâœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼åˆè¨ˆ' + successCount + 'ä»¶ç™»éŒ²ã—ã¾ã—ãŸ');
  }

  function parseCSVLine(line) {
    var result = [];
    var current = '';
    var inQuotes = false;
    for (var i = 0; i < line.length; i++) {
      var ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i+1] === '"') { current += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if (ch === ',' && !inQuotes) {
        result.push(current); current = '';
      } else {
        current += ch;
      }
    }
    result.push(current);
    return result;
  }

}); // DOMContentLoadedçµ‚ã‚ã‚Š
</script>
</body>
</html>
