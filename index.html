<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¤ãƒ™ãƒ³ãƒˆè²©å£²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Hiragino Sans', sans-serif; background: #f0f4f8; }
  .header { background: #2c3e50; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
  .tabs { display: flex; background: #34495e; }
  .tab { padding: 12px 24px; color: #bdc3c7; cursor: pointer; border: none; background: none; font-size: 14px; }
  .tab.active { background: #f0f4f8; color: #2c3e50; font-weight: bold; }
  .content { padding: 20px; max-width: 900px; margin: 0 auto; }
  .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
  input[type=text], input[type=number] { padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; flex: 1; }
  input:focus { border-color: #3498db; outline: none; }
  button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; }
  .btn-primary { background: #3498db; color: white; }
  .btn-success { background: #27ae60; color: white; font-size: 18px; padding: 14px 28px; width: 100%; }
  .btn-danger { background: #e74c3c; color: white; }
  .btn-warning { background: #f39c12; color: white; }
  .btn-gray { background: #95a5a6; color: white; }
  button:active { opacity: 0.8; }
  table { width: 100%; border-collapse: collapse; }
  th { background: #2c3e50; color: white; padding: 10px; text-align: left; }
  td { padding: 10px; border-bottom: 1px solid #eee; }
  tr:hover td { background: #f8f9fa; }
  .total-area { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 16px; }
  .total-amount { font-size: 36px; font-weight: bold; }
  .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; }
  .badge-ok { background: #27ae60; color: white; }
  .badge-ng { background: #e74c3c; color: white; }
  .hidden { display: none; }
  .scan-mode { background: #fff3cd; border: 2px solid #ffc107; padding: 12px; border-radius: 6px; margin-bottom: 12px; }
  .alert { padding: 10px; border-radius: 6px; margin-bottom: 10px; }
  .alert-error { background: #fdecea; border: 1px solid #e74c3c; color: #c0392b; }
  .alert-success { background: #eafaf1; border: 1px solid #27ae60; color: #1e8449; }
  #stockResult { margin-top: 16px; }
  .stock-item { padding: 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #3498db; }
</style>
</head>
<body>

<div class="header">
  <span>ğŸ“¦ ã‚¤ãƒ™ãƒ³ãƒˆè²©å£²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </span>
  <span id="currentTime" style="font-size:13px;"></span>
</div>

<div class="tabs" id="tabBar">
  <!-- ã‚¿ãƒ–ã¯JSå´ã§å‹•çš„ã«ç”Ÿæˆ -->
</div>

<!-- ===== ä¼šè¨ˆã‚¿ãƒ– ===== -->
<div id="tab-pos" class="content">

  <div class="total-area">
    <div style="font-size:14px; margin-bottom:4px;">åˆè¨ˆé‡‘é¡</div>
    <div class="total-amount">Â¥<span id="totalAmount">0</span></div>
    <div style="font-size:13px; margin-top:4px;"><span id="itemCount">0</span>ç‚¹</div>
  </div>

  <div class="card">
    <h3 style="margin-bottom:12px;">å•†å“ã‚¹ã‚­ãƒ£ãƒ³</h3>
    <div id="scanStep1" class="scan-mode">
      <div style="font-size:13px; color:#856404; margin-bottom:8px;">ã€STEP 1ã€‘å“ç•ªãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ ã¾ãŸã¯å…¥åŠ›</div>
      <div class="input-row">
        <input type="text" id="itemCodeInput" placeholder="å“ç•ªï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ or æ‰‹å…¥åŠ›ï¼‰">
        <button class="btn-primary" id="btnConfirmItem">ç¢ºå®š</button>
      </div>
    </div>
    <div id="scanStep2" class="scan-mode hidden" style="background:#d4edda; border-color:#28a745;">
      <div style="font-size:13px; color:#155724; margin-bottom:8px;">ã€STEP 2ã€‘å€‰åº«QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
      <div id="scannedItemInfo" style="margin-bottom:8px; font-weight:bold;"></div>
      <div class="input-row">
        <input type="text" id="warehouseCodeInput" placeholder="å€‰åº«ã‚³ãƒ¼ãƒ‰ï¼ˆQRã‚³ãƒ¼ãƒ‰ or æ‰‹å…¥åŠ›ï¼‰">
        <button class="btn-primary" id="btnAddItem">è¿½åŠ </button>
      </div>
      <button class="btn-gray" id="btnCancelStep2" style="margin-top:4px;">â† å“ç•ªå…¥åŠ›ã«æˆ»ã‚‹</button>
    </div>
    <div id="scanMessage"></div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h3>ã‚«ãƒ¼ãƒˆ</h3>
      <button class="btn-warning" id="btnToggleManual">æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</button>
    </div>

    <div id="manualInputArea" class="hidden" style="background:#fff3cd; padding:12px; border-radius:6px; margin-bottom:12px;">
      <h4 style="margin-bottom:8px;">æ‰‹å‹•å…¥åŠ›</h4>
      <div class="input-row">
        <input type="text" id="manualItemCode" placeholder="å“ç•ª">
        <input type="text" id="manualWarehouseCode" placeholder="å€‰åº«ã‚³ãƒ¼ãƒ‰">
        <input type="number" id="manualQty" placeholder="æ•°é‡" value="1" style="width:80px; flex:none;">
        <button class="btn-primary" id="btnManualAdd">è¿½åŠ </button>
      </div>
    </div>

    <table id="cartTable">
      <thead><tr><th>å€‰åº«</th><th>å“ç•ª</th><th>å“å</th><th>å˜ä¾¡</th><th>æ•°é‡</th><th>å°è¨ˆ</th><th>å‰Šé™¤</th></tr></thead>
      <tbody id="cartBody"></tbody>
    </table>
    <div style="margin-top:12px; text-align:right; font-size:13px; color:#666;" id="cartEmpty">å•†å“ãŒã‚¹ã‚­ãƒ£ãƒ³ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
  </div>

  <button class="btn-success" id="btnComplete">âœ… ä¼šè¨ˆçµ‚äº†ï¼ˆæ±ºæ¸ˆå®Œäº†å¾Œã«æŠ¼ã™ï¼‰</button>
  <button class="btn-danger" id="btnClearCart" style="width:100%; margin-top:10px;">ğŸ—‘ï¸ ã‚«ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<!-- ===== åœ¨åº«ç¢ºèªã‚¿ãƒ– ===== -->
<div id="tab-stock" class="content hidden">
  <div class="card">
    <h3 style="margin-bottom:12px;">åœ¨åº«æ¤œç´¢</h3>
    <div class="input-row">
      <input type="text" id="stockSearchInput" placeholder="å“ç•ªã‚’ã‚¹ã‚­ãƒ£ãƒ³ or å…¥åŠ›">
      <button class="btn-primary" id="btnStockSearch">æ¤œç´¢</button>
    </div>
  </div>
  <div id="stockResult"></div>
</div>

<!-- ===== ä¼šè¨ˆå±¥æ­´ã‚¿ãƒ– ===== -->
<div id="tab-history" class="content hidden">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h3>ä¼šè¨ˆå±¥æ­´</h3>
      <button class="btn-primary" id="btnReloadHistory">ğŸ”„ æ›´æ–°</button>
    </div>
    <div id="historyList">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

  // ==================== Supabaseè¨­å®š ====================
  const SUPABASE_URL = 'https://exvbrwcpaoxxatokqfta.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4dmJyd2NwYW94eGF0b2txZnRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MTgyNDQsImV4cCI6MjA4Njk5NDI0NH0.HmrY7SWbWvJhzao1L4270YHK0ypE4HQXvCh3Z50uH18';


  // å¤‰æ•°åã‚’dbã«çµ±ä¸€ï¼ˆsupabaseã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè‡ªèº«ãŒä½¿ç”¨ã™ã‚‹ãŸã‚ï¼‰
  const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ==================== PCç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š ====================
  // â˜…ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§PCç”¨URLã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã¾ã™
  var PC_PASSWORD = '1234';

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆä¾‹: index.html?pw=1234ï¼‰
  var urlParams = new URLSearchParams(window.location.search);
  var isPCMode = urlParams.get('pw') === PC_PASSWORD;

  // switchTabã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆã‚¿ãƒ–ã®onclickã‚ˆã‚Šå…ˆã«å®šç¾©ãŒå¿…è¦ï¼‰
  window.switchTab = switchTab;

  // ==================== ã‚¿ãƒ–åˆæœŸåŒ– ====================
  var tabBar = document.getElementById('tabBar');
  if (isPCMode) {
    // PCãƒ¢ãƒ¼ãƒ‰ï¼šä¼šè¨ˆãƒ»åœ¨åº«ç¢ºèªãƒ»ä¼šè¨ˆå±¥æ­´ ã™ã¹ã¦è¡¨ç¤º
    tabBar.innerHTML =
      '<button class="tab active" onclick="switchTab(\'pos\')">ğŸ›’ ä¼šè¨ˆ</button>' +
      '<button class="tab" onclick="switchTab(\'stock\')">ğŸ” åœ¨åº«ç¢ºèª</button>' +
      '<button class="tab" onclick="switchTab(\'history\')">ğŸ“‹ ä¼šè¨ˆå±¥æ­´</button>';
    document.getElementById('tab-pos').classList.remove('hidden');
    document.getElementById('tab-stock').classList.add('hidden');
    document.getElementById('tab-history').classList.add('hidden');
    // ãƒ˜ãƒƒãƒ€ã«PCãƒ¢ãƒ¼ãƒ‰ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
    document.querySelector('.header span').insertAdjacentHTML(
      'afterend',
      '<span style="background:#27ae60;color:white;padding:2px 8px;border-radius:4px;font-size:12px;margin-left:10px;">PCãƒ¢ãƒ¼ãƒ‰</span>'
    );
  } else {
    // ã‚¹ãƒãƒ›ãƒ¢ãƒ¼ãƒ‰ï¼šåœ¨åº«ç¢ºèªã‚¿ãƒ–ã®ã¿è¡¨ç¤º
    tabBar.innerHTML =
      '<button class="tab active" onclick="switchTab(\'stock\')">ğŸ” åœ¨åº«ç¢ºèª</button>';
    document.getElementById('tab-pos').classList.add('hidden');
    document.getElementById('tab-stock').classList.remove('hidden');
    document.getElementById('tab-history').classList.add('hidden');
  }

  // ==================== çŠ¶æ…‹ç®¡ç† ====================
  var cart = [];
  var pendingItemCode = null;

  // ==================== æ™‚è¨ˆ ====================
  setInterval(function() {
    document.getElementById('currentTime').textContent = new Date().toLocaleString('ja-JP');
  }, 1000);

  // ==================== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² ====================
  document.getElementById('btnConfirmItem').addEventListener('click', confirmItemCode);
  document.getElementById('btnAddItem').addEventListener('click', addItem);
  document.getElementById('btnCancelStep2').addEventListener('click', cancelStep2);
  document.getElementById('btnToggleManual').addEventListener('click', toggleManualInput);
  document.getElementById('btnManualAdd').addEventListener('click', manualAddItem);
  document.getElementById('btnComplete').addEventListener('click', completeTransaction);
  document.getElementById('btnClearCart').addEventListener('click', clearCart);
  document.getElementById('btnStockSearch').addEventListener('click', searchStock);
  document.getElementById('btnReloadHistory').addEventListener('click', loadHistory);

  document.getElementById('itemCodeInput').addEventListener('keydown', function(e) { if (e.key === 'Enter') confirmItemCode(); });
  document.getElementById('warehouseCodeInput').addEventListener('keydown', function(e) { if (e.key === 'Enter') addItem(); });
  document.getElementById('stockSearchInput').addEventListener('keydown', function(e) { if (e.key === 'Enter') searchStock(); });

  // åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  if (isPCMode) {
    document.getElementById('itemCodeInput').focus();
  } else {
    document.getElementById('stockSearchInput').focus();
  }

  // ==================== ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ====================
  function switchTab(tab) {
    ['pos','stock','history'].forEach(function(t) {
      document.getElementById('tab-' + t).classList.toggle('hidden', t !== tab);
    });
    document.querySelectorAll('.tab').forEach(function(el, i) {
      el.classList.toggle('active', ['pos','stock','history'][i] === tab);
    });
    if (tab === 'history') loadHistory();
    if (tab === 'stock') document.getElementById('stockSearchInput').focus();
    if (tab === 'pos') document.getElementById('itemCodeInput').focus();
  }

  // ==================== ä¼šè¨ˆå‡¦ç† ====================

  async function confirmItemCode() {
    var code = document.getElementById('itemCodeInput').value.trim();
    if (!code) return;

    var result = await db.from('inventory').select('*').eq('item_code', code).gt('quantity', 0);
    if (result.error || !result.data || !result.data.length) {
      showMessage('scanMessage', 'å“ç•ª "' + code + '" ã®åœ¨åº«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    pendingItemCode = code;
    document.getElementById('scannedItemInfo').textContent = 'å“ç•ª: ' + code;
    document.getElementById('scanStep1').classList.add('hidden');
    document.getElementById('scanStep2').classList.remove('hidden');
    document.getElementById('warehouseCodeInput').value = '';
    document.getElementById('warehouseCodeInput').focus();
    clearMessage('scanMessage');
  }

  async function addItem() {
    var warehouseCode = document.getElementById('warehouseCodeInput').value.trim();
    if (!warehouseCode || !pendingItemCode) return;

    var result = await db.from('inventory')
      .select('*').eq('item_code', pendingItemCode).eq('warehouse_code', warehouseCode).single();

    if (result.error || !result.data) {
      showMessage('scanMessage', 'å€‰åº« "' + warehouseCode + '" ã«å“ç•ª "' + pendingItemCode + '" ã®åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
      return;
    }
    if (result.data.quantity <= 0) {
      showMessage('scanMessage', 'åœ¨åº«åˆ‡ã‚Œã§ã™', 'error');
      return;
    }

    var existing = cart.find(function(i) { return i.item_code === result.data.item_code && i.warehouse_code === result.data.warehouse_code; });
    if (existing) {
      existing.quantity++;
    } else {
      cart.push({ warehouse_code: result.data.warehouse_code, item_code: result.data.item_code, item_name: result.data.item_name, unit_price: result.data.unit_price, quantity: 1 });
    }

    renderCart();
    resetScanStep();
    showMessage('scanMessage', 'âœ… ' + result.data.item_name + ' ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
  }

  function cancelStep2() {
    resetScanStep();
  }

  function resetScanStep() {
    pendingItemCode = null;
    document.getElementById('itemCodeInput').value = '';
    document.getElementById('warehouseCodeInput').value = '';
    document.getElementById('scanStep1').classList.remove('hidden');
    document.getElementById('scanStep2').classList.add('hidden');
    document.getElementById('itemCodeInput').focus();
  }

  function renderCart() {
    var tbody = document.getElementById('cartBody');
    tbody.innerHTML = '';
    var total = 0;
    var count = 0;
    cart.forEach(function(item, idx) {
      var subtotal = item.unit_price * item.quantity;
      total += subtotal;
      count += item.quantity;
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td>' + item.warehouse_code + '</td>' +
        '<td>' + item.item_code + '</td>' +
        '<td>' + item.item_name + '</td>' +
        '<td>Â¥' + item.unit_price.toLocaleString() + '</td>' +
        '<td>' +
          '<button onclick="changeQty(' + idx + ', -1)" style="padding:2px 8px;">-</button>' +
          ' ' + item.quantity + ' ' +
          '<button onclick="changeQty(' + idx + ', 1)" style="padding:2px 8px;">+</button>' +
        '</td>' +
        '<td>Â¥' + subtotal.toLocaleString() + '</td>' +
        '<td><button class="btn-danger" onclick="removeItem(' + idx + ')" style="padding:4px 10px;">å‰Šé™¤</button></td>';
      tbody.appendChild(tr);
    });
    document.getElementById('totalAmount').textContent = total.toLocaleString();
    document.getElementById('itemCount').textContent = count;
    document.getElementById('cartEmpty').style.display = cart.length ? 'none' : 'block';
  }

  window.removeItem = function(idx) {
    cart.splice(idx, 1);
    renderCart();
  };

  window.changeQty = function(idx, delta) {
    cart[idx].quantity += delta;
    if (cart[idx].quantity <= 0) cart.splice(idx, 1);
    renderCart();
  };

  function clearCart() {
    if (!confirm('ã‚«ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
    cart = [];
    renderCart();
    resetScanStep();
    clearMessage('scanMessage');
  }

  function toggleManualInput() {
    document.getElementById('manualInputArea').classList.toggle('hidden');
  }

  async function manualAddItem() {
    var itemCode = document.getElementById('manualItemCode').value.trim();
    var warehouseCode = document.getElementById('manualWarehouseCode').value.trim();
    var qty = parseInt(document.getElementById('manualQty').value) || 1;
    if (!itemCode || !warehouseCode) { alert('å“ç•ªã¨å€‰åº«ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    var result = await db.from('inventory')
      .select('*').eq('item_code', itemCode).eq('warehouse_code', warehouseCode).single();
    if (result.error || !result.data) { alert('å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

    var existing = cart.find(function(i) { return i.item_code === result.data.item_code && i.warehouse_code === result.data.warehouse_code; });
    if (existing) { existing.quantity += qty; } else {
      cart.push({ warehouse_code: result.data.warehouse_code, item_code: result.data.item_code, item_name: result.data.item_name, unit_price: result.data.unit_price, quantity: qty });
    }
    renderCart();
    document.getElementById('manualItemCode').value = '';
    document.getElementById('manualWarehouseCode').value = '';
  }

  async function completeTransaction() {
    if (cart.length === 0) { alert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™'); return; }
    if (!confirm('Â¥' + document.getElementById('totalAmount').textContent + ' ã®ä¼šè¨ˆã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ')) return;

    var total = cart.reduce(function(sum, i) { return sum + i.unit_price * i.quantity; }, 0);

    var txResult = await db.from('transactions').insert({ total_amount: total }).select().single();
    if (txResult.error) { alert('ä¼šè¨ˆç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + txResult.error.message); return; }

    var items = cart.map(function(i) {
      return { transaction_id: txResult.data.id, warehouse_code: i.warehouse_code, item_code: i.item_code, item_name: i.item_name, unit_price: i.unit_price, quantity: i.quantity };
    });
    await db.from('transaction_items').insert(items);

    // åœ¨åº«æ¸›ç®—
    for (var j = 0; j < cart.length; j++) {
      var item = cart[j];
      await db.rpc('decrement_inventory', {
        p_warehouse_code: item.warehouse_code,
        p_item_code: item.item_code,
        p_qty: item.quantity
      });
    }

    alert('âœ… ä¼šè¨ˆå®Œäº†ï¼\nå–å¼•ID: ' + txResult.data.id + '\nåˆè¨ˆ: Â¥' + total.toLocaleString() + '\n' + new Date().toLocaleString('ja-JP'));
    cart = [];
    renderCart();
    resetScanStep();
  }

  // ==================== åœ¨åº«ç¢ºèª ====================
  async function searchStock() {
    var code = document.getElementById('stockSearchInput').value.trim();
    if (!code) return;

    var result = await db.from('inventory').select('*').eq('item_code', code).order('warehouse_code');
    var el = document.getElementById('stockResult');

    if (result.error || !result.data || !result.data.length) {
      el.innerHTML = '<div class="alert alert-error">å“ç•ª "' + code + '" ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
      return;
    }

    var totalQty = result.data.reduce(function(s, r) { return s + r.quantity; }, 0);
    var html = '<div class="card"><h3>' + result.data[0].item_name + 'ï¼ˆ' + code + 'ï¼‰</h3>';
    html += '<p style="margin:8px 0;">åˆè¨ˆåœ¨åº«: <strong>' + totalQty + 'ç‚¹</strong></p>';
    result.data.forEach(function(r) {
      html += '<div class="stock-item">' +
        '<span class="badge ' + (r.quantity > 0 ? 'badge-ok' : 'badge-ng') + '">' + (r.quantity > 0 ? 'åœ¨åº«ã‚ã‚Š' : 'åœ¨åº«ãªã—') + '</span> ' +
        'å€‰åº«: <strong>' + r.warehouse_code + '</strong> ï¼ æ®‹æ•°: <strong>' + r.quantity + 'ç‚¹</strong>' +
        '</div>';
    });
    html += '</div>';
    el.innerHTML = html;
  }

  // ==================== ä¼šè¨ˆå±¥æ­´ ====================
  async function loadHistory() {
    var result = await db.from('transactions').select('*, transaction_items(*)').order('completed_at', { ascending: false }).limit(50);
    var el = document.getElementById('historyList');
    if (result.error || !result.data) { el.innerHTML = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼'; return; }
    if (!result.data.length) { el.innerHTML = 'ä¼šè¨ˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“'; return; }

    el.innerHTML = result.data.map(function(tx) {
      return '<div style="border:1px solid #ddd; border-radius:6px; padding:12px; margin-bottom:10px;">' +
        '<div style="display:flex; justify-content:space-between;">' +
          '<strong>å–å¼•ID: ' + tx.id + '</strong>' +
          '<span>Â¥' + tx.total_amount.toLocaleString() + '</span>' +
        '</div>' +
        '<div style="font-size:12px; color:#666; margin:4px 0;">' + new Date(tx.completed_at).toLocaleString('ja-JP') + '</div>' +
        '<details>' +
          '<summary style="cursor:pointer; font-size:13px; color:#3498db;">æ˜ç´°ã‚’è¦‹ã‚‹ï¼ˆ' + tx.transaction_items.length + 'ç‚¹ï¼‰</summary>' +
          '<table style="margin-top:8px; font-size:13px; width:100%;">' +
            '<tr><th>å€‰åº«</th><th>å“ç•ª</th><th>å“å</th><th>å˜ä¾¡</th><th>æ•°é‡</th></tr>' +
            tx.transaction_items.map(function(i) {
              return '<tr><td>' + i.warehouse_code + '</td><td>' + i.item_code + '</td><td>' + i.item_name + '</td><td>Â¥' + i.unit_price.toLocaleString() + '</td><td>' + i.quantity + '</td></tr>';
            }).join('') +
          '</table>' +
        '</details>' +
      '</div>';
    }).join('');
  }

  // ==================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====================
  function showMessage(id, msg, type) {
    document.getElementById(id).innerHTML = '<div class="alert alert-' + type + '">' + msg + '</div>';
    setTimeout(function() { clearMessage(id); }, 4000);
  }
  function clearMessage(id) {
    document.getElementById(id).innerHTML = '';
  }

}); // DOMContentLoadedçµ‚ã‚ã‚Š
</script>
</body>
</html>

